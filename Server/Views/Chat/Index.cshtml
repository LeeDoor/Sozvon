<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Video Conference - Чат</title>
    <link rel="stylesheet" href="~/css/chat.css">
</head>
<body>
    <div class="main-container">
        <!-- Левая часть - видео конференция -->
        <div class="video-container">
            <div class="video-placeholder">
                <h2>Видеоконференция</h2>
                <p>Здесь будет отображаться видео участников</p>
            </div>
            <div class="video-controls">
                <button class="control-btn">🎥</button>
                <button class="control-btn">🎤</button>
                <button class="control-btn" style="background: #e74c3c;">📞</button>
            </div>
        </div>

        <!-- Правая часть - чат -->
        <div class="chat-container">
            <div class="chat-header">
                💬 Чат конференции
            </div>
            <div class="participants">
                Участников онлайн: <span id="participantCount">1</span>
            </div>
            <div id="chatroom"></div>
            <div class="input-container">
                <input type="text" id="userName" placeholder="Ваше имя" />
                <input type="text" id="message" placeholder="Введите сообщение..." />
                <button id="sendBtn" disabled>Отправить</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
<script>
    const hubConnection = new signalR.HubConnectionBuilder()
        .withUrl("/chat")
        .build();

    // Функция для добавления сообщения в чат
    function addMessage(userName, message, isOwn = false) {
        const messageElement = document.createElement("div");
        messageElement.className = `message ${isOwn ? 'sent' : 'received'}`;
        
        const userNameElement = document.createElement("b");
        userNameElement.textContent = `${userName}:`;
        
        const textElement = document.createTextNode(message);
        
        messageElement.appendChild(userNameElement);
        messageElement.appendChild(textElement);
        
        const chatroom = document.getElementById("chatroom");
        chatroom.appendChild(messageElement);
        
        // Прокрутка вниз
        chatroom.scrollTop = chatroom.scrollHeight;
    }

    // Обработчик отправки сообщения
    document.getElementById("sendBtn").addEventListener("click", function () {
        const userName = document.getElementById("userName").value;
        const message = document.getElementById("message").value;

        if (!userName.trim()) {
            alert("Пожалуйста, введите ваше имя");
            return;
        }

        if (!message.trim()) {
            alert("Пожалуйста, введите сообщение");
            return;
        }

        // Отправка сообщения на сервер
        hubConnection.invoke("Send", message, userName)
            .catch(function (err) {
                console.error(err.toString());
            });

        // Очистка поля ввода сообщения
        document.getElementById("message").value = '';
    });

    // Обработчик нажатия Enter в поле сообщения
    document.getElementById("message").addEventListener("keypress", function (e) {
        if (e.key === 'Enter') {
            document.getElementById("sendBtn").click();
        }
    });

    // Обработчик получения сообщения от сервера
    hubConnection.on("Receive", function (message, userName) {
        const currentUserName = document.getElementById("userName").value;
        const isOwnMessage = userName === currentUserName;
        
        addMessage(userName, message, isOwnMessage);
    });

    // Обновление состояния кнопки при вводе имени
    document.getElementById("userName").addEventListener("input", function() {
        const userName = this.value.trim();
        const sendBtn = document.getElementById("sendBtn");
        sendBtn.disabled = !userName;
    });

    // Запуск соединения
    hubConnection.start()
        .then(function () {
            document.getElementById("sendBtn").disabled = false;
            addMessage("Система", "Добро пожаловать в чат конференции! Введите ваше имя и начинайте общение.");
        })
        .catch(function (err) {
            console.error(err.toString());
        });
</script>
</body>
</html>